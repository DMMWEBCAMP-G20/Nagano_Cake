<h1>ショッピングカート</h1>

<%= link_to "カートを空にする", empty_path,class:"btn btn-danger" %>

<table class="table table-bordered">
	<thead>
		<tr>
			<th>商品名</th>
			<th>単価(税込)</th>
			<th>数量</th>
			<th>小計</th>
      <th></th>
		</tr>
	</thead>
	<tbody>
    <% @cart_items.each do |cart_item| %>
      <tr>
        <td>
          <%= attachment_image_tag cart_item.product, :image, :fill, 30, 30, fallback: "no-image-mini.jpg"  %>
          <%= cart_item.product.name %>
        </td>
        <td>
          <% taxed_price = cart_item.product.price * 1.1 %>
          <%= taxed_price.round %>
        </td>
        <td>
          <%= cart_item.quantity %>
          <%= form_with model: @cart_items, url: cart_item_path(cart_item), method: :patch do |f| %>
            <%= f.text_field :quantity %>
            <%= f.submit "更新", class:"btn btn-info" %>
          <% end %>
        </td>
        <td>
          <% taxed_total_price = taxed_price * cart_item.quantity %>
          <%= taxed_total_price.round.to_s(:delimited) %>
        </td>
        <td><%= link_to "削除する", cart_item_path(cart_item), method: :delete, class: "btn-sm btn-danger" %></td>
      </tr>
    <% end %>
	</tbody>
</table>

<table class="table table-bordered">
	<tbody>
      <tr>
        <td>合計金額</td>
        <td>
          <% @total_price = 0 %>
          <% @cart_items.each do |cart_item| %>
          <% @total_price += cart_item.product.price * cart_item.quantity %>
          <% taxed_total_price = @total_price * 1.1 %>
          <% @sum = taxed_total_price.round.to_s(:delimited) %>
          <% end %>
          <%= @sum %>
        </td>
      </tr>
	</tbody>
</table>

<%= link_to "買い物を続ける", products_path, class:"btn btn-info" %>
<%= link_to "情報入力に進む", root_path, class:"btn btn-success" %>